# Bluethooth APP for TENS
![image](https://user-images.githubusercontent.com/50388568/109662327-e5ca6900-7ba5-11eb-9605-0f8a03b99e85.png)
  
  BuleTooth APP是2019年开发的项目，项目的初衷是用于与同蓝牙串口进行通信交互，并根据通信数据内容进行不同的处理。APP开发的初期参考了不少开源项目，但是与自己的项目需求存在较大差距，因此有了这个项目的诞生。
  该项目的开发是在Android Studio上完成的，感兴趣的朋友们可以在上面继续进行改进。APP由两个Activity组成，主界面是作为通信交互接口以及同步显示，第二界面是作为连接界面，主要负责获取本地和主控板的设备信息并连接。
## Main idea

  本APP采用多线程设计模式，实现基于套接字通信的蓝牙交互接口。从数据流的角度分析，主要是实现两个方面的功能，一个是处理接收数据信息和指令反馈，一个是发送控制指令和数据信息。
## * Communication between threads

  考虑到安卓蓝牙的socket API接口采用的是阻塞式的传输和接收方式，因此，在设计的时候为了保证主线程界面不会出现卡死的状况，需要在设计的时候采用多个线程进行管理。同时，为了方便后期资源的释放，本系统将蓝牙通信的连接线程、接收和发送线程以及释放线程打包在一个消息服务类中，通过主线程新建蓝牙通信类，即可实现蓝牙管理。主线程和通信线程之间，采用了消息队列实现，通信线程将需要发送的消息写成msg类。Handler实例操作消息队列，向消息队列中添加新的消息，Handler通过Looper管道将消息发送主线程中，主线程向通信线程发送信息的过程也是类似的。
## * Implementation of Bluetooth Communication Class

  通信类的实现主要是采用了三个子线程。一是负责连接蓝牙设备的线程。二是负责设备连接成功之后的输入输出消息线程。三是设备请求连接线程（本线程的作用是允许主控板主动向手机设备发送连接请求）。
  首先，通信类的初始化需要取得用户权限，打开 服务。出于安全考虑， 以上版本， 权限列入手动申请权限。因此，我们在构造函数中先主动向用户请求蓝牙权限，以获取用户本地配对的蓝牙设备和周边蓝牙设备的地址信息。
连接线程的实现，通过用户点击事件，获取当前待连接设备的地址信息。建立套接字，将设备信息配置到套接字中，向设备发起连接请求并建立通信。连接成功后，连接线程取消，释放内存资源，开启通信线程。由于阻塞接收，线程需要一直从输入输出流中去获取通信消息，通过 发送数据给主线程进行消息判定和命令解析。监听连接线程，在非通信转态下，处于等待设备的连接请求状态。设备连接成功后，获取设备信息并启动通信线程。
